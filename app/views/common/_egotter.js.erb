(function(global){
  var Exception = function (msg1, msg2) {
    this.msg1 = msg1;
    this.msg2 = msg2;
    this.isLogin = <%= user_signed_in? ? 'true' : 'false' %>;
  };

  Exception.prototype.showMessage = function () {
    $('.error-msg').html(this.isLogin ? this.msg1 : this.msg2);
    $('.rescue-box').show();
  };

  var retryTimeout = function (via) {
    var message = '<%= t('before_sign_in.retry_timeout_html', sign_in_path: welcome_path(via: 'VIA')).html_safe %>';
    return message.replace('VIA', via);
  };

  var somethingWrong = function (via) {
    var message = '<%= t('before_sign_in.something_wrong_html', sign_in_path: welcome_path(via: 'VIA')).html_safe %>';
    return message.replace('VIA', via);
  };

  var empty = function (via) {
    var message = '<%= t('searches.common.empty_html', sign_in_path: welcome_path(via: 'VIA')).html_safe %>';
    return message.replace('VIA', via);
  };

  var tooManyRequests = new Exception(
    '<%= I18n.t('after_sign_in.too_many_requests') %>',
    '<%= raw I18n.t('before_sign_in.too_many_requests_html', sign_in_path: welcome_path(via: 'client/too_many_requests')) %>'
  );

  var unauthorized = new Exception(
    '<%= raw I18n.t('after_sign_in.unauthorized_html', sign_in_path: welcome_path(via: 'client/unauthorized'), sign_out_path: sign_out_path) %>',
    '<%= raw I18n.t('before_sign_in.unauthorized_html', sign_in_path: welcome_path(via: 'client/unauthorized')) %>'
  );

  var somethingError = new Exception(
    '<%= raw I18n.t('after_sign_in.something_wrong_html') %>',
    somethingWrong('client/something_wrong')
  );

  var timeout = new Exception(
    '<%= raw I18n.t('after_sign_in.retry_timeout_html') %>',
    retryTimeout('client/retry_timeout')
  );

  global.egotter = global.egotter || {};

  global.egotter.errors = {
    TooManyRequests: tooManyRequests, // <%= BackgroundSearchLog::TooManyRequests::MESSAGE %>
    Unauthorized: unauthorized,       // <%= BackgroundSearchLog::Unauthorized::MESSAGE %>
    SomethingError: somethingError,   // <%= BackgroundSearchLog::SomethingError::MESSAGE %>
    Timeout: timeout
  };

  global.egotter.messages = {
    retryTimeout: retryTimeout,
    somethingWrong: somethingWrong,
    empty: empty
  };

  global.egotter.controllerName = '<%= controller_name %>';
  global.egotter.actionName = '<%= action_name %>';

  global.egotter.backgroundSearchLogPath = "<%= background_search_log_path(uid: 'UID') %>";
  global.egotter.pollingLogsPath = "<%= raw polling_logs_path(uid: 'UID', screen_name: 'SCREEN_NAME') %>";

  var PageCache = function () {
    this.pageCachePath = "<%= raw page_cache_path(uid: 'UID', hash: 'HASH') %>";
    this.pageCachesPath = "<%= raw page_caches_path(uid: 'UID') %>";
  };

  PageCache.prototype.delete = function (uid) {
    console.log('delete started', new Date());
    var url = this.pageCachePath.replace(/UID/, uid);
    return $.ajax({url: url, type: 'DELETE'});
  };

  PageCache.prototype.create = function create(uid) {
    console.log('create started', new Date());
    var url = this.pageCachesPath.replace(/UID/, uid);
    return $.post(url);
  };

  global.egotter.PageCache = PageCache;

})(window);