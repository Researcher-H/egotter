.update-box.alert.alert-info.alert-dismissable
  %a.close(href="#" data-dismiss="alert" aria-label="close") &times;
  = t('common.show.updating', user: twitter_user.mention_name)
  = image_tag '/ajax-loader.gif'

.refresh-box.alert.alert-info.alert-dismissable
  %a.close(href="#" data-dismiss="alert" aria-label="close") &times;
  %span= t('common.show.update_is_coming', user: twitter_user.mention_name)
  = link_to(t('common.show.update_result'), timeline_path(twitter_user, via: build_via('refresh_box')), class: 'btn btn-default btn-sm')

.too-many-friends-box.alert.alert-info.alert-dismissable
  %a.close(href="#" data-dismiss="alert" aria-label="close") &times;
  = t('common.show.need_sign_in', user: twitter_user.mention_name)
  = link_to(t('common.show.sign_in'), sign_in_path(via: build_via('welcome_box'), redirect_path: timeline_path(twitter_user)), class: 'btn btn-default btn-sm')

.follow-box.alert.alert-warning.alert-dismissable
  %a.close(href="#" data-dismiss="alert" aria-label="close") &times;
  = t('common.show.need_follow', user: twitter_user.mention_name)
  = link_to(t('common.show.follow'), sign_in_path(via: build_via('follow_box'), redirect_path: timeline_path(twitter_user), follow: true), class: 'btn btn-default btn-sm')

.invalid-token-box.alert.alert-warning.alert-dismissable
  %a.close(href="#" data-dismiss="alert" aria-label="close") &times;
  = t('common.show.invalid_token', user: twitter_user.mention_name)
  = link_to(t('common.show.sign_in'), sign_in_path(via: build_via('invalid_token'), redirect_path: timeline_path(twitter_user)), class: 'btn btn-default btn-sm')

.additional-func-box.alert.alert-warning.alert-dismissable
  %a.close(href="#" data-dismiss="alert" aria-label="close") &times;
  = t('common.show.additional_func')
  = link_to(t('common.show.sign_in'), sign_in_path(via: build_via('additional_func'), redirect_path: timeline_path(twitter_user)), class: 'btn btn-default btn-sm')

.via-dm-box.alert.alert-warning.alert-dismissable
  %a.close(href="#" data-dismiss="alert" aria-label="close") &times;
  = t('common.show.via_dm')
  = link_to(t('common.show.sign_in'), sign_in_path(via: build_via('via_dm'), redirect_path: timeline_path(twitter_user)), class: 'btn btn-default btn-sm')

:javascript
  (function () {
    var $updateBox, $refreshBox, $tooManyFriendsBox, $followBox, $invalidTokenBox, $additionalFuncBox, $viaDMBox;

    function checkFollow () {
      var url = '#{check_follow_path}';
      $.getJSON(url, function (res) {
        console.log('checkFollow', res);

        if (!res.follow) {
          $followBox.show().sticky();
        }
      });
    }

    function updatesNotFound (signedIn) {
      var friendless = #{twitter_user.no_need_to_import_friendships?};
      var searchMyself = #{user_signed_in? && current_user.uid.to_i == twitter_user.uid.to_i};

      if (signedIn) {
        if (searchMyself) {
          checkFollow();
        }
      } else {
        if (friendless) {
          $tooManyFriendsBox.show().sticky();
        }
      }
    }

    function checkForUpdates (jid, signedIn) {
      if (!jid) {
        updatesNotFound(signedIn);
        return;
      }

      var url = '#{check_for_updates_path(uid: twitter_user.uid, created_at: twitter_user.created_at.to_i, jid: 'JID').html_safe}';

      console.log('Worker started', jid);
      $updateBox.show().sticky();

      window.checkForUpdates(url.replace("JID", jid), {interval: 8000},
        function (res) {
          $updateBox.alert('close');
          if (res.text) {
            $refreshBox.find('span').text(res.text);
          }
          $refreshBox.show().sticky();
        }, function (res) {
          $updateBox.alert('close');
          updatesNotFound(signedIn);
        }, function (xhr) {
          $updateBox.alert('close');
          console.log('checkForUpdates failed.', xhr);
        });
    }

    $(function () {
      var signedIn = #{user_signed_in?};
      var authorized = #{user_signed_in? && current_user.authorized?};
      var additionalFunc = #{!user_signed_in? && %w(unfriends unfollowers blocking_or_blocked).include?(controller_name)};
      var viaDM = #{via_dm?};

      $updateBox = $('.update-box');
      $refreshBox = $('.refresh-box');
      $tooManyFriendsBox = $('.too-many-friends-box');
      $followBox = $('.follow-box');
      $invalidTokenBox = $('.invalid-token-box');
      $additionalFuncBox = $('.additional-func-box');
      $viaDMBox = $('.via-dm-box');

      $.each([$updateBox, $refreshBox, $tooManyFriendsBox, $followBox, $invalidTokenBox, $additionalFuncBox, $viaDMBox], function (i, btn) {
        btn.on('close.bs.alert', function () {
          btn.parent().hide();
        });
      });

      if (signedIn && !authorized) {
        $invalidTokenBox.show().sticky();
      }

      if (additionalFunc) {
        $additionalFuncBox.show().sticky();
      }

      if (!signedIn && viaDM) {
        $viaDMBox.show().sticky();
      }

      var url = '#{twitter_users_path}';
      var uid = '#{twitter_user.uid}';
      $.post(url, {uid: uid}, function (res) {
        console.log(res);
        checkForUpdates(res.jid, signedIn);
      });
    });
  })();
