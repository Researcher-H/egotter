<div class="my-3">
  <%= render partial: 'twitter/profile', locals: {user: @twitter_user} %>
</div>

<div id="waiting-msg" class="alert alert-info text-center mb-3">
  <%= t('.analyzing', user: @twitter_user.name) %>&nbsp;<%= image_tag '/ajax-loader-blue.gif' %>
</div>

<div id="finished-msg" class="alert alert-success text-center mb-3" style="display: none;">
  <%= t(".finished") %>&nbsp;<%= image_tag '/ajax-loader-blue.gif' %>
</div>

<div id="error-msg" class="alert alert-warning text-left mb-3" style="display: none;">
  <%= t('.something_wrong_html', url: sign_in_path(via: current_via('something_wrong'))) %>
</div>

<div id="waiting-progress">
  <div class="bar">
    <div class="progress">
      <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <span class="sr-only">0% Complete</span>
      </div>
    </div>
  </div>
</div>

<div class="buttons row" style="display: none;">
  <div class="col-12 col-sm-12 col-md-4 text-center mb-3">
    <%= link_to t('.retry_search_by', user: @twitter_user.screen_name), searches_path(screen_name: @twitter_user.screen_name, via: current_via('waiting_retry')), class: 'btn btn-lg btn-outline-primary', method: :post %>
  </div>

  <div class="col-12 col-sm-12 col-md-4 text-center mb-3">
    <%= sign_in_with_twitter_link(nil, 'sign_in_button', class: 'btn btn-lg btn-primary') %>
  </div>

  <div class="col-12 col-sm-12 col-md-4 text-center mb-3">
    <%= link_to t('.link_to_support'), support_path(via: current_via), class: 'btn btn-lg btn-outline-primary' %>
  </div>
</div>

<script>
  function redirectTo(url) {
    window.location.replace(url);
  }

  var url = "<%= twitter_user_path(uid: @twitter_user.uid, via: current_via) %>";
  var redirectPath = "<%= @redirect_path %>";
  var signedIn = <%= user_signed_in? %>;
  var timeoutMessage = '<%= t('.retry_timeout_html', url: sign_in_path(via: current_via('waiting_timeout'))) %>';

  var twitterUser = {
    userId: '<%= current_user&.id %>',
    uid: "<%= @twitter_user.uid %>",
    screenName: "<%= @twitter_user.screen_name %>"
  };

  var alertBox = new Waiting.AlertBox(signedIn, timeoutMessage);

  $(function () {
    Waiting.poll(url, {interval: 3000}, function done(res) {
      console.log('success', res);
      alertBox.finished();
      redirectTo(redirectPath);

    }, function keep_on(res, options) {
      console.log('continue', res, options);
      alertBox.keepOn();

    }, function stopped(res) {
      console.log('stop', res);
      alertBox.failed();

      // ga('send', {
      //   hitType: 'event',
      //   eventCategory: 'waiting#new',
      //   eventAction: 'Retry exhausted',
      //   eventLabel: JSON.stringify(twitterUser)
      // });
    }, function fail(xhr) {
      console.log('failed', xhr.responseText);

      var res = $.parseJSON(xhr.responseText || null);
      if (res && res.message) {
        alertBox.setErrorMessage(res.message);
      }
      alertBox.failed();

      // ga('send', {
      //   hitType: 'event',
      //   eventCategory: 'Waiting#new',
      //   eventAction: 'Failed',
      //   eventLabel: JSON.stringify($.extend({status: xhr.status}, twitterUser))
      // });
    });
  });
</script>
