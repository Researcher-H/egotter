<%= render partial: 'twitter/profile', locals: {user: @twitter_user} %>

<div id="waiting-msg" class="alert alert-info text-center">
  <%= t('.analyzing', user: @twitter_user.name) %>&nbsp;<%= image_tag '/ajax-loader-blue.gif' %>
</div>

<div id="finished-msg" class="alert alert-success text-center" style="display: none;">
  <%= t(".finished") %>&nbsp;<%= image_tag '/ajax-loader-blue.gif' %>
</div>

<div id="error-msg" class="alert alert-warning text-left" style="display: none;">
  <%= t('.something_wrong_html', url: sign_in_path(via: build_via('something_wrong'))) %>
</div>

<div id="waiting-progress" class="row">
  <div class="hidden-xs hidden-sm col-md-2"></div>
  <div class="col-xs-12 col-sm-12 col-md-8">
    <div class="bar">
      <div class="progress">
        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <span class="sr-only">0% Complete</span>
        </div>
      </div>
    </div>
  </div>
  <div class="hidden-xs hidden-sm col-md-2"></div>
</div>

<div class="row">
  <div class="col-xs-12 col-sm-4 text-center">
    <div id="retry-btn" style="display: none;">
      <%= link_to t('.retry_search_by', user: @twitter_user.screen_name), searches_path(screen_name: @twitter_user.screen_name, via: build_via('waiting_retry')), class: 'btn btn-lg btn-default', method: :post %>
    </div>
    <div class="vertical-spacing"></div>
  </div>

  <div class="col-xs-12 col-sm-4 text-center">
    <div id="login-btn" style="display: none;">
      <%= sign_in_with_twitter_link(nil, 'sign_in_button', class: 'btn btn-lg btn-info') %>
    </div>
    <div class="vertical-spacing"></div>
  </div>

  <div class="col-xs-12 col-sm-4 text-center">
    <div id="support-btn" style="display: none;">
      <%= link_to t('.link_to_support'), support_path(via: build_via), class: 'btn btn-lg btn-default' %>
    </div>
    <div class="vertical-spacing"></div>
  </div>
</div>

<%= render(partial: 'adsense/side_by_side', locals: {vertical: :top}) %>

<script>
  $(function () {
    var url = "<%= twitter_user_path(uid: @twitter_user.uid, via: build_via) %>";
    var redirectPath = "<%= @redirect_path %>";
    var signedIn = <%= user_signed_in? %>;
    var timeoutMessage = '<%= t('.retry_timeout_html', url: sign_in_path(via: build_via('waiting_timeout'))) %>';

    var twitterUser = {
      userId: '<%= current_user&.id %>',
      uid: "<%= @twitter_user.uid %>",
      screenName: "<%= @twitter_user.screen_name %>"
    };

    var alertBox = new Waiting.AlertBox(signedIn, timeoutMessage);

    Waiting.poll(url, {interval: 3000}, function done(res) {
      console.log('success', res);
      alertBox.finished();
      window.location.replace(redirectPath);

    }, function keep_on(res, options) {
      console.log('continue', res, options);
      alertBox.keepOn();

    }, function stopped(res) {
      console.log('stop', res);
      alertBox.failed();

      ga('send', {
        hitType: 'event',
        eventCategory: 'waiting#new',
        eventAction: 'Retry exhausted',
        eventLabel: JSON.stringify(twitterUser)
      });
    }, function fail(xhr) {
      console.log('failed', xhr.responseText);

      var res = $.parseJSON(xhr.responseText || null);
      if (res && res.message) {
        alertBox.setErrorMessage(res.message);
      }
      alertBox.failed();

      ga('send', {
        hitType: 'event',
        eventCategory: 'Waiting#new',
        eventAction: 'Failed',
        eventLabel: JSON.stringify($.extend({status: xhr.status}, twitterUser))
      });
    });
  });
</script>
