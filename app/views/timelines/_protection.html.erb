<%= render partial: 'timelines/placeholder', locals: {menu_name: menu_name, menu_or_users: 'menu'} %>

<div class="menu-items media <%= menu_name %>" style="display: none; position: relative;">
  <%= link_to search_path_for(menu_name, twitter_user.screen_name), class: 'result-link' do %>
    <h3 class="h4"><%= t("#{menu_name}.show.summary_title") %></h3>
    <div class="text-center description"><%= t("#{menu_name}.show.page_description", user: twitter_user.mention_name) %></div>
  <% end %>

  <div style="position: absolute; bottom: 15px; left: 15px; right: 15px;">
    <div class="media-body">
      <div class="text-muted text-center progress-msg" style="display: none;"></div>
    </div>

    <%= link_to(t('timelines.show.reinvestigate'), timeline_path(twitter_user), class: 'btn btn-info btn-block reload-btn', style: 'display: none;') %>
    <%= link_to(t('timelines.show.sign_in_and_investigate'), sign_in_path(via: "#{controller_name}/#{action_name}/#{menu_name}", redirect_path: timeline_path(twitter_user)), class: 'btn btn-info btn-block sign-in-btn', style: 'display: none;') %>
    <%= link_to(t('timelines.show.view_more_hacked_with_num_html', num: 'NUM'), protection_path(twitter_user), class: 'btn btn-danger btn-block btn-view-more', style: 'display: none;') %>
  </div>
</div>

<script>
  $(function () {
    var menuName = '<%= menu_name %>';
    var apiEndpoint = '<%= send("api_v1_#{menu_name}_summary_path", uid: twitter_user.uid) %>';
    var signedIn = <%= user_signed_in? %>;
    var progressMessages = {
      ok: "<%= t('timelines.show.not_hacked_with_details_html') %>",
      found: '<%= t('timelines.show.hacked_with_details_html') %>',
      login: '<%= t('timelines.show.sign_in_to_protect_html', url: sign_in_path(via: "#{controller_name}/#{action_name}/#{menu_name}", redirect_path: timeline_path(twitter_user))) %>'
    };

    function loadProtectionSummary (apiEndpoint, summaryBox, progressMessages) {
      $.getJSON(apiEndpoint, function(data) {
        console.log(data);

        if (!data.count || data.count <= 0) {
          summaryBox.link(false);
          summaryBox.messageBox().html(progressMessages.ok).show();
          summaryBox.reloadBtn().show();
          summaryBox.show();
          return;
        }

        summaryBox.viewMoreBtn(data.count).show();
        summaryBox.messageBox().switchClass('text-muted', 'text-danger').html(progressMessages.found).show();
        summaryBox.show();
      });
    }

    var summaryBox = new SummaryBox(menuName);

    summaryBox.lazyload(function () {
      if (signedIn) {
        loadProtectionSummary(apiEndpoint, summaryBox, progressMessages);
      } else {
        summaryBox.link(false);
        summaryBox.messageBox().html(progressMessages.login).show();
        summaryBox.signInBtn().show();
        summaryBox.show();
      }
    });
  });
</script>