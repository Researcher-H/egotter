<div class="settings">
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

  <%= render partial: 'general' %>

  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

  <h2 class="h4 text-center"><i class="fas fa-search">&nbsp;</i><%= t('.search_title') %></h2>

  <hr>

  <div class="col-xs-4"><%= t('.search_mode.title') %></div>
  <div class="col-xs-8">
    <% if current_user.search_mode.fast? %>
      <div><%= t(".search_mode.fast") %></div>
      <div class="text-muted notes"><%= t('.search_mode.advantage') %></div>
    <% else %>
      <div><%= t(".search_mode.#{current_user.search_mode}") %></div>
      <div class="text-muted notes"><%= t('.search_mode.advise_html') %></div>
    <% end %>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div class="col-xs-4"><%= t('.search_count.title') %></div>
  <div class="col-xs-8">
    <div>
      <%= t('.search_count.count', count: SearchCountLimitation.max_search_count(current_user)) %>
      <%= t('.search_count.remaining', count: SearchCountLimitation.remaining_search_count(user: current_user)) %>
      <span><a href="#" data-target="#search-modal" data-toggle="modal"><%= t('.search_count.history') %></a></span>
    </div>
    <div class="text-muted notes"><%= t('.search_count.note', days: SearchCountLimitation::SEARCH_COUNT_PERIOD / 1.day) %></div>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div id="follow-count" class="col-xs-4"><%= t('.follow_count.title') %></div>
  <div class="col-xs-8">
    <div>
      <%= t('.follow_count.count', count: CreateFollowLimitation.max_count(current_user)) %><%= t('.follow_count.remaining', count: CreateFollowLimitation.remaining_count(current_user)) %>
      <span><a href="<%= settings_follow_requests_path %>"><%= t('.follow_count.history') %></a></span>
    </div>
    <div class="text-muted notes"><%= t('.follow_count.note', days: CreateFollowLimitation::CREATE_FOLLOW_PERIOD / 1.day) %></div>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div id="unfollow-count" class="col-xs-4"><%= t('.unfollow_count.title') %></div>
  <div class="col-xs-8">
    <div>
      <%= t('.unfollow_count.count', count: CreateUnfollowLimitation.max_count(current_user)) %><%= t('.unfollow_count.remaining', count: CreateUnfollowLimitation.remaining_count(current_user)) %>
      <span><a href="<%= settings_unfollow_requests_path %>"><%= t('.unfollow_count.history') %></a></span>
    </div>
    <div class="text-muted notes"><%= t('.unfollow_count.note', days: CreateUnfollowLimitation::CREATE_UNFOLLOW_PERIOD / 1.day) %></div>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

  <h2 class="h4 text-center"><i class="far fa-envelope"></i>&nbsp;<%= t('.notifications.title') %></h2>

  <div class="tgl-buttons">
    <hr>
    <%= render partial: 'tgl_btn', collection: %i(dm email news search), as: :name %>
  </div>

  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

  <%= render partial: 'prompt_report' %>

  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

  <h2 class="h4 text-center"><i class="fas fa-database"></i>&nbsp;<%= t('.data.title') %></h2>

  <hr>

  <div class="col-xs-4"><%= t('.data.updated_at') %></div>
  <div class="col-xs-8">
    <div>
      <%= (twitter_user = TwitterUser.latest_by(uid: current_user.uid)) ? l(twitter_user.created_at.in_time_zone('Tokyo'), format: :prompt_report_short) : t('.data.no_records') %>
      <span><a href="<%= settings_twitter_users_path %>"><%= t('.data.history') %></a></span>
    </div>
    <div class="text-muted notes"><%= t('.data.note') %></div>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div class="col-xs-4"><%= t('.data.reset_cache.title') %></div>
  <div class="col-xs-8">
    <div>
      <% if @reset_cache_request %>
        <div class="btn btn-warning reset-cache-btn" disabled="disabled"><%= t('.data.reset_cache.do') %></div>
        <div class="text-muted notes"><%= t('.data.requested') %></div>
      <% else %>
        <div class="btn btn-warning reset-cache-btn" data-toggle="modal" data-target="#reset-cache-modal"><%= t('.data.reset_cache.do') %></div>
        <div class="text-muted notes"><%= t('.data.reset_cache.note') %></div>
      <% end %>
    </div>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div class="col-xs-4"><%= t('.data.delete_data.title') %></div>
  <div class="col-xs-8">
    <div>
      <% if @reset_egotter_request %>
        <div class="btn btn-danger reset-egotter-btn" disabled="disabled"><%= t('.data.delete_data.do') %></div>
        <div class="text-muted notes"><%= t('.data.requested') %></div>
      <% else %>
        <div class="btn btn-danger reset-egotter-btn" data-toggle="modal" data-target="#reset-egotter-modal"><%= t('.data.delete_data.do') %></div>
        <div class="text-danger notes"><%= t('.data.delete_data.note') %></div>
      <% end %>
    </div>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div class="col-xs-4"><%= t('.data.delete_tweets.title') %></div>
  <div class="col-xs-8">
    <div><a href="<%= delete_tweets_path %>"><%= t('delete_tweets.new.simple_title') %></a><%= t('.data.delete_tweets.move_to') %></div>
  </div>

  <div class="clearfix"></div>
  <hr>

  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

  <h2 class="h4 text-center"><i class="fas fa-shopping-cart"></i>&nbsp;<%= t('.order.order_histories') %></h2>
  <div class="vertical-spacing"></div>

  <div class="text-center"><%= link_to t('.order.see_plans'), pricing_path(via: current_via('orders_table')) %></div>
  <div class="vertical-spacing"></div>

  <% if current_user.orders.any? %>
    <table id="orders-table" class="table">
      <tbody>
      <% current_user.orders.select { |o| !o.purchase_failed? }.each do |order| %>
        <tr class="<%= 'text-muted' if order.canceled_at %>">
          <td>
            <div><%= order.name %></div>
            <div><%= t('.order.created_at', date: l(order.created_at.in_time_zone('Tokyo'), format: :order_short)) %></div>
          </td>
          <td>
            <% unless order.canceled_at %>
              <div><%= t('.order.not_canceled') %></div>
            <% end %>
            <div><%= t('.order.price', price: order.price) %></div>
            <% unless order.canceled_at %>
              <div><%= t('.order.search_count', count: order.search_count) %></div>
              <div><%= t('.order.follow_requests_count', count: order.follow_requests_count) %></div>
              <div><%= t('.order.unfollow_requests_count', count: order.unfollow_requests_count) %></div>
            <% end %>
          </td>
          <% if order.canceled_at %>
            <td>
              <div><%= t('.order.canceled') %></div>
              <div><%= t('.order.canceled_at', date: l(order.canceled_at.in_time_zone('Tokyo'), format: :order_short)) %></div>
            </td>
          <% else %>
            <td>
              <div><%= link_to t('.order.cancel'), order_path(id: order.id), method: :delete, data: {confirm: t('.order.cancel_confirmation', name: order.name)} %></div>
            </td>
          <% end %>
        </tr>
      <% end %>
      </tbody>
    </table>
  <% else %>
    <table class="table">
      <tbody>
      <tr>
        <td><%= t('.order.has_not_purchased') %></td>
      </tr>
      </tbody>
    </table>
  <% end %>

  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

  <h2 class="h4 text-center"><%= t('.trial_title') %></h2>

  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>
  <div class="vertical-spacing"></div>

</div>

<div class="modal fade" id="reset-egotter-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title"><%= t('.data.delete_data.title') %></h4>
      </div>
      <div class="modal-body">
        <p><%= t('.data.delete_data.modal.warning_html', screen_name: current_user.screen_name) %></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal"><%= t('.data.delete_data.modal.cancel') %></button>
        <button type="button" class="btn btn-danger ok" data-url="<%= reset_egotter_path %>"><%= t('.data.delete_data.modal.ok') %></button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reset-cache-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title"><%= t('.data.reset_cache.title') %></h4>
      </div>
      <div class="modal-body">
        <p><%= t('.data.reset_cache.modal.warning_html') %></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal"><%= t('.data.reset_cache.modal.cancel') %></button>
        <button type="button" class="btn btn-warning ok" data-url="<%= reset_cache_path %>"><%= t('.data.reset_cache.modal.ok') %></button>
      </div>
    </div>
  </div>
</div>

<script>
  $(function () {
    $('.update-following').on('click', function () {
      var $clicked = $(this);
      Twitter.follow($clicked.data('url'), $clicked.data('uid'));
      return false;
    });

    Settings.enableResetEgotterButton();
    Settings.enableResetCacheButton();

    (function () {
      var url = '<%= setting_path %>';
      attach_event_handler('email', url);
      attach_event_handler('dm', url);
      attach_event_handler('news', url);
      attach_event_handler('search', url);
      attach_event_handler('report_if_changed', url);
    })();

    (function () {
      var url = '<%= update_report_interval_path %>';
      var defaultValue = <%= NotificationSetting::DEFAULT_REPORT_INTERVAL %>;
      var message = '<%= t('settings.index.report_interval.confirm') %>';
      Settings.enableUpdateReportIntervalButton(url, function (value, label) {
        if (value > defaultValue) {
          return confirm(message.replace(/_INTERVAL_/, label));
        } else {
          return true;
        }
      });
    })();
  });
</script>
