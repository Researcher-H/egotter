<div><a href="/">egotter</a></div>
<br>

<table border="1">
  <caption>Total Records</caption>
  <tr>
    <th>name</th>
    <th>total</th>
    <th>(last 1hour)</th>
    <th>uniq</th>
    <th>(last 1hour)</th>
  </tr>
  <% [User, TwitterUser, Friend, Follower, Status, Mention, SearchResult].each do |model| %>
    <tr>
      <td><%= model.model_name %></td>
      <td><%= model.all.size %></td>
      <td><%= model.where(created_at: @last_1hour).size %></td>
      <td><%= model.count('DISTINCT uid') %></td>
      <td><%= model.where(created_at: @last_1hour).count('DISTINCT uid') %></td>
    </tr>
  <% end %>
</table>
<br>

<table border="1">
  <caption>Queueing</caption>
  <% @debug_info.each do |k, v| %>
    <tr>
      <td><%= k %></td>
      <td><%= v %></td>
    </tr>
  <% end %>
</table>
<br>

<table border="1">
  <caption>Worker</caption>
  <tr>
    <th>name</th>
    <th>total</th>
    <th>(last 1hour)</th>
    <th>success</th>
    <th>(last 1hour)</th>
    <th>failure</th>
    <th>(last 1hour)</th>
    <th>success rate</th>
    <th>(last 1hour)</th>
  </tr>
  <% [BackgroundSearchLog, BackgroundUpdateLog].each do |model| %>
    <tr>
      <td><%= model.model_name %></td>
      <td><%= model.all.size %></td>
      <td><%= model.where(created_at: @last_1hour).size %></td>
      <td><%= model.where(status: true).size %></td>
      <td><%= model.where(status: true, created_at: @last_1hour).size %></td>
      <td><%= model.where(status: false).size %></td>
      <td><%= model.where(status: false, created_at: @last_1hour).size %></td>
      <td><%= model.where(status: true).size.to_f / model.all.size rescue 0.0 %></td>
      <td><%= model.where(status: true, created_at: @last_1hour).size.to_f / model.where(created_at: @last_1hour).size rescue 0.0 %></td>
    </tr>
  <% end %>
</table>
<br>

<% [BackgroundSearchLog, BackgroundUpdateLog].each do |model| %>
  <table border="1">
    <caption>Worker Reasons(<%= model.model_name %>)</caption>
    <tr>
      <th>name</th>
      <th>id</th>
      <th>reason</th>
      <th>message</th>
      <th>created_at</th>
    </tr>
    <% model.where(status: false).order(created_at: :desc).limit(50).each do |log| %>
      <tr>
        <td><%= model.model_name %></td>
        <td><%= log.id %></td>
        <td><%= log.reason %></td>
        <td><%= log.message %></td>
        <td><%= l(log.created_at + 9.hours, format: :short) %></td>
      </tr>
    <% end %>
  </table>
  <br>
<% end %>

<div><a href="/">egotter</a></div>
