<% title @title %>
<% set_meta_tags description: "#{@title} - #{@searched_tw_user.description}" %>

<div class="row">
  <div class="hidden-xs col-sm-1 col-md-2 col-lg-3"></div>
  <div class="col-xs-12 col-sm-10 col-md-8 col-lg-6">

    <p class="alert alert-info" style="display: none;">
      <%= t("dictionary.updating_is_finished_msg", link: link_to(t('dictionary.this_link'), '#')).html_safe %>
    </p>

    <%= render(partial: 'searches/profile_overview',
               locals: {user: @searched_tw_user, enable_carousel: true, unique_id: "#{@searched_tw_user.screen_name}_#{@searched_tw_user.object_id}"}) %>

    <div class="search-result">
      <h2>
        <small><%= @title %></small>
      </h2>
    </div>

    <%= render(partial: 'searches/adsense') %>

    <div style="padding: 15px 0px 0px 0px;">
      <%= render(partial: 'searches/search_menu_items',
                 locals: {searched_tw_user: @searched_tw_user,
                          menu_items: @menu_items,
                          menu_update_histories: @menu_update_histories,
                          menu_common_friends_and_followers: @menu_common_friends_and_followers,
                          close_friends: @menu_close_friends,
                          usage_stats: @menu_usage_stats,
                          clusters_belong_to: @menu_clusters_belong_to}) %>
    </div>

  </div>
  <div class="hidden-xs col-sm-1 col-md-2 col-lg-3"></div>
</div>

<script>
  $(function () {
    var check_update = <%= @searched_tw_user.created_at < 1.hour.ago %>;
    var created_at = <%= @searched_tw_user.created_at.to_i %>;
    var interval = 2000;
    var max_interval = 5000;
    var retry_count = 0;
    var max_retry_count = 5;
    var hash = null;
    var refresh_box = $('.alert.alert-info');
    var refresh_btn = refresh_box.find('a');

    refresh_btn.on('click', function (e) {
      refresh();
      e.preventDefault();
      e.stopPropagation();
      return false
    });

    function refresh() {
      var url = "<%= raw url_for(caches_delete_path(id: @searched_tw_user.uid, hash: 'HASH')) %>";
      $.ajax({url: url.replace(/HASH/, hash), type: 'DELETE'})
          .done(function (res) {
            console.log(res);

            if (res.status == 200) {
              window.location.reload();
            }
          })
          .fail(function (xhr) {
            console.log(xhr.responseText);
          });
    }

    function tic() {
      if (!check_update) {
        return
      }

      $.post("<%= url_for waiting_path(screen_name: @searched_tw_user.screen_name, id: @searched_tw_user.uid) %>")
          .done(function (res) {
            console.log(res, interval, retry_count);

            if (res.status == 200) {
              if (created_at < res.created_at) {
                hash = res.hash;
                refresh_box.show();
              } else {
                console.log('the result is latest.')
              }
            } else if (retry_count >= max_retry_count) {
              console.log('stop waiting');
            } else {
              retry_count++;
              interval += 2000;
              if (interval > max_interval) interval = max_interval;
              setTimeout(tic, interval);
            }
          })
          .fail(function (xhr) {
            console.log(xhr.responseText);
          });
    }

    tic();
  });
</script>