<div style="padding: 15px 0px 0px 0px;">
  <%= render(partial: 'searches/search_menu_items',
             locals: {searched_tw_user: @searched_tw_user,
                      menu_items: @menu_items,
                      menu_update_histories: @menu_update_histories,
                      menu_common_friends_and_followers: @menu_common_friends_and_followers,
                      close_friends: @menu_close_friends,
                      usage_stats: @menu_usage_stats,
                      clusters_belong_to: @menu_clusters_belong_to}) %>
</div>

<script>
  $(function () {
    var check_update = <%= @searched_tw_user.created_at < 1.hour.ago %>;
    var created_at = <%= @searched_tw_user.created_at.to_i %>;
    var interval = 2000;
    var max_interval = 5000;
    var retry_count = 0;
    var max_retry_count = 5;
    var hash = null;
    var refresh_box = $('.alert.alert-info');
    var refresh_btn = refresh_box.find('a');
    var delete_cache_url = "<%= raw url_for(page_cache_path(id: @searched_tw_user.uid, hash: 'HASH')) %>";
    var create_cache_url = "<%= raw url_for(page_caches_path(id: @searched_tw_user.uid)) %>";

    refresh_btn.on('click', function (e) {
      refresh();
      e.preventDefault();
      e.stopPropagation();
      return false
    });

    function refresh() {
      delete_cache(delete_cache_url, hash).done(function () {
        create_cache(create_cache_url).done(function () {
          window.location.reload();
        })
      })
    }

    function tic() {
      if (!check_update) {
        return
      }

      $.get("<%= url_for background_search_log_path(id: @searched_tw_user.uid) %>")
          .done(function (res) {
            console.log(res, interval, retry_count);

            if (res.status == 200) {
              if (created_at < res.created_at) {
                hash = res.hash;
                refresh_box.show();
              } else {
                console.log('the result is latest.')
              }
            } else if (retry_count >= max_retry_count) {
              console.log('stop waiting');
            } else {
              retry_count++;
              interval += 2000;
              if (interval > max_interval) interval = max_interval;
              setTimeout(tic, interval);
            }
          })
          .fail(function (xhr) {
            console.log(xhr.responseText);
          });
    }

    tic();
  });
</script>